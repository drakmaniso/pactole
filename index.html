<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Pactole</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="application-name" content="Pactole">
  <meta name="theme-color" content="#ffffff">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" sizes="512x512" href="images/icon-512x512.png">
  <link rel="apple-touch-icon" href="images/icon-512x512.png">

  <style>
    @font-face {
      font-family: 'Font Awesome 5 Free';
      font-style: normal;
      font-weight: 900;
      font-display: swap;
      src: url("fonts/fa-solid-900.woff2");
    }

    @font-face {
      font-family: 'Andika New Basic';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: url('fonts/andika-new-basic-v15-latin-regular.woff2');
    }

    @font-face {
      font-family: 'Andika New Basic';
      font-style: normal;
      font-weight: 700;
      font-display: swap;
      src: url('fonts/andika-new-basic-v15-latin-700.woff2');
    }

    @font-face {
      font-family: 'System UI';
      font-style: normal;
      font-weight: 400;
      src: local(".SFNS-Regular"), local(".SFNSText-Regular"), local(".HelveticaNeueDeskInterface-Regular"), local(".LucidaGrandeUI"), local("Segoe UI"), local("Ubuntu"), local("Roboto-Regular"), local("DroidSans"), local("Tahoma");
    }

    @font-face {
      font-family: 'System UI';
      font-style: normal;
      font-weight: 500;
      src: local(".SFNS-Medium"), local(".SFNSText-Medium"), local(".HelveticaNeueDeskInterface-MediumP4"), local(".LucidaGrandeUI"), local("Segoe UI Semibold"), local("Ubuntu Medium"), local("Roboto-Medium"), local("DroidSans-Bold"), local("Tahoma Bold");
    }

    @font-face {
      font-family: 'System UI';
      font-style: normal;
      font-weight: 700;
      src: local(".SFNS-Bold"), local(".SFNSText-Bold"), local(".HelveticaNeueDeskInterface-Bold"), local(".LucidaGrandeUI"), local("Segoe UI Bold"), local("Ubuntu Bold"), local("Roboto-Bold"), local("DroidSans-Bold"), local("Tahoma Bold");
    }

    .focus-visible-only:focus-visible {
      border: 4px solid #FFD000;
    }

    .focus-visible-only-interior {
      box-shadow: inset 0px 0px 4px solid #FFD000;

    }

    .scrollbox {
      background:
        linear-gradient(white 30%, rgba(255, 255, 255, 0)),
        linear-gradient(rgba(255, 255, 255, 0), white 70%) 0 100%,
        radial-gradient(50% 0, farthest-side, rgba(0, 0, 0, .4), rgba(0, 0, 0, 0)),
        radial-gradient(50% 100%, farthest-side, rgba(0, 0, 0, .4), rgba(0, 0, 0, 0)) 0 100%;
      background:
        linear-gradient(white 30%, rgba(255, 255, 255, 0)),
        linear-gradient(rgba(255, 255, 255, 0), white 70%) 0 100%,
        radial-gradient(farthest-side at 50% 0, rgba(0, 0, 0, .4), rgba(0, 0, 0, 0)),
        radial-gradient(farthest-side at 50% 100%, rgba(0, 0, 0, .4), rgba(0, 0, 0, 0)) 0 100%;
      background-repeat: no-repeat;
      background-color: white;
      background-size: 100% 40px, 100% 40px, 100% 14px, 100% 14px;
      background-attachment: local, local, scroll, scroll;
    }

    .scrollbox-alt {
      position: relative;
      z-index: 1;


      background: #FFF no-repeat;
      background-image:
        -webkit-radial-gradient(50% 0, farthest-side, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0)),
        -webkit-radial-gradient(50% 100%, farthest-side, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0));
      background-image:
        -moz-radial-gradient(50% 0, farthest-side, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0)),
        -moz-radial-gradient(50% 100%, farthest-side, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0));
      background-image:
        radial-gradient(farthest-side at 50% 0, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0)),
        radial-gradient(farthest-side at 50% 100%, rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0));
      background-position: 0 0, 0 100%;
      background-size: 100% 14px;
    }

    .dotted-line:after {
      content: ".....................................................................................";
      color: rgba(0, 0, 0, 0.4);
      overflow: clip;
    }

    .scrollbox-alt:before,
    .scrollbox-alt:after {
      content: "";
      position: relative;
      z-index: -1;

      display: block;

      height: 30px;
      margin: 0 0 -30px;
      background: -webkit-linear-gradient(top, #FFF, #FFF 30%, rgba(255, 255, 255, 0));
      background: -moz-linear-gradient(top, #FFF, #FFF 30%, rgba(255, 255, 255, 0));
      background: linear-gradient(to bottom, #FFF, #FFF 30%, rgba(255, 255, 255, 0));
    }

    .scrollbox:after {
      margin: -30px 0 0;
      background: -webkit-linear-gradient(top, rgba(255, 255, 255, 0), #FFF 70%, #FFF);
      background: -moz-linear-gradient(top, rgba(255, 255, 255, 0), #FFF 70%, #FFF);
      background: linear-gradient(to bottom, rgba(255, 255, 255, 0), #FFF 70%, #FFF);
    }

    .desktop-dialog-shadow {
      box-shadow:
        32px 64px 32px 0px rgba(0, 0, 0, 0.04),
        16px 32px 16px 0px rgba(0, 0, 0, 0.08),
        8px 16px 8px 0px rgba(0, 0, 0, 0.16),
        4px 8px 4px 0px rgba(0, 0, 0, 0.32),
        2px 4px 2px 0px rgba(0, 0, 0, 0.32),
        1px 2px 1px 0px rgba(0, 0, 0, 0.32),
        0px 1px 1px 0px rgba(0, 0, 0, 0.64);
    }

    .panel-shadow {
      box-shadow:
        0px 0px 16px 16px rgba(0, 0, 0, 0.02),
        0px 0px 8px 8px rgba(0, 0, 0, 0.04),
        0px 0px 4px 4px rgba(0, 0, 0, 0.08),
        0px 0px 2px 1px rgba(0, 0, 0, 0.16)
    }

    .small-shadow {
      box-shadow:
        3px 6px 6px 0px rgba(0, 0, 0, 0.04),
        1px 2px 2px 0px rgba(0, 0, 0, 0.08),
        0px 1px 1px 0px rgba(0, 0, 0, 0.16)
    }

    .button-shadow {
      box-shadow:
        3px 6px 8px 0px rgba(0, 0, 0, 0.04),
        2px 4px 4px 0px rgba(0, 0, 0, 0.08),
        1px 2px 2px 0px rgba(0, 0, 0, 0.16)
    }

    .button-shadow:active {
      box-shadow:
        2px 4px 4px 0px rgba(0, 0, 0, 0.04),
        1px 2px 2px 0px rgba(0, 0, 0, 0.08),
        0px 1px 1px 0px rgba(0, 0, 0, 0.16)
    }

    .round-button:active {
      transform: translate(0, 2px);
    }

    .no-slide {
      transform: translate(0, 0);
    }

    .slide-from-left-0 {
      animation: slide-from-left-0 0.3s ease;
    }

    .slide-from-left-1 {
      animation: slide-from-left-1 0.3s ease;
    }

    .slide-from-right-0 {
      animation: slide-from-right-0 0.3s ease;
    }

    .slide-from-right-1 {
      animation: slide-from-right-1 0.3s ease;
    }

    @keyframes slide-from-left-0 {
      from {
        transform: translateX(-100%);
      }

      to {
        transform: translateX(0%);
      }
    }

    @keyframes slide-from-left-1 {
      from {
        transform: translateX(-100%);
      }

      to {
        transform: translateX(0%);
      }
    }

    @keyframes slide-from-right-0 {
      from {
        transform: translateX(100%);
      }

      to {
        transform: translateX(0%);
      }
    }

    @keyframes slide-from-right-1 {
      from {
        transform: translateX(100%);
      }

      to {
        transform: translateX(0%);
      }
    }

    .slide-to-left-0 {
      animation: slide-to-left-0 0.3s ease;
      transform: translateX(100%);
    }

    .slide-to-left-1 {
      animation: slide-to-left-1 0.3s ease;
      transform: translateX(100%);
    }

    .slide-to-right-0 {
      animation: slide-to-right-0 0.3s ease;
      transform: translateX(-100%);
    }

    .slide-to-right-1 {
      animation: slide-to-right-1 0.3s ease;
      transform: translateX(-100%);
    }

    @keyframes slide-to-left-0 {
      from {
        transform: translateX(0%);
      }

      to {
        transform: translateX(100%);
      }
    }

    @keyframes slide-to-left-1 {
      from {
        transform: translateX(0%);
      }

      to {
        transform: translateX(100%);
      }
    }

    @keyframes slide-to-right-0 {
      from {
        transform: translateX(0%);
      }

      to {
        transform: translateX(-100%);
      }
    }

    @keyframes slide-to-right-1 {
      from {
        transform: translateX(0%);
      }

      to {
        transform: translateX(-100%);
      }
    }
  </style>
  <script src="elm.js"></script>
</head>

<body>
  <noscript>This application requires javascript.</noscript>
  <p style="color: #aaa;">Chargement de l'application Pactole...</p>
  <script>

    // PROGRESSIVE WEB APP ////////////////////////////////////////////////////

    if (!('indexedDB' in window)) {
      fatalError('IndexedDB not supported by browser.')
    }

    if (!('serviceWorker' in navigator)) {
      fatalError('service workers not supported by the navigator.')
    }

    if (!(navigator.storage && navigator.storage.persist)) {
      fatalError('no persistent storage API')
    }


    //TODO: add a settings button to call this?
    let updateService
    onload = () => {
      navigator.serviceWorker
        .register('./service.js')
        .then(registration => {
          updateService = () => registration.update()
          if (registration.installing) {
            log(
              `Service registration: installing (scope: ${registration.scope})`,
            )
          } else if (registration.waiting) {
            log(
              `Service registration: waiting (scope: ${registration.scope})`,
            )
          } else if (registration.active) {
            log(
              `Service registration: active (scope: ${registration.scope})`,
            )
          }
          registration.onupdatefound = () => {
            let w = registration.installing
            log(`Update found: installation in progress...`)
            w.onstatechange = event => {
              if (event.target.state === 'installed') {
                log(`The update has been installed.`)
              }
            }
          }
        })
        .catch(err => error(`Service registration failed: ${err}`))
    }


    // ELM STUFF //////////////////////////////////////////////////////////////


    navigator.serviceWorker.ready
      .then(_ => {
        // Check persistent storage status
        navigator.storage.persisted()
          .then(isPersisted => {
            log(`Storage is persisted: ${isPersisted}`)

            const today = new Date()
            const flags = {
              today: {
                year: today.getFullYear(),
                month: today.getMonth(),
                day: today.getDate()
              },
              width: window.innerWidth,
              height: window.innerHeight,
              isStoragePersisted: isPersisted
            }
            const app = Elm.Main.init({ flags: flags })

            // Connect service worker to Elm runtime

            navigator.serviceWorker.onmessage = event => {
              log(`Received "${event.data.title}".`)
              app.ports.fromServiceWorker.send([event.data.title, event.data.content])
            }
            app.ports.toServiceWorker.subscribe(function (args) {
              try {
                [title, content] = args
                sendToServiceWorker(title, content)
              }
              catch (err) {
                error(`forwarding service worker message: ${err}`)
              }
            })

            // Handle back button

            app.ports.historyPushState.subscribe(function (args) {
              history.pushState(null, document.title, location.href)
            })
            window.onpopstate = event => {
              app.ports.onPopState.send(null)
            }
            app.ports.historyGo.subscribe(delta => {
              history.go(delta)
            })

            // Handle Touch Horizontal Swipes

            var xTouch = null
            var yTouch = null
            document.ontouchstart = event => {
              xTouch = event.touches[0].clientX
              yTouch = event.touches[0].clientY
            }
            document.ontouchmove = event => {
              if (!xTouch || !yTouch) {
                return
              }
              const x = event.touches[0].clientX
              const y = event.touches[0].clientY
              const xDiff = x - xTouch
              const yDiff = y - yTouch
              if (Math.abs(xDiff) > Math.abs(yDiff)) {
                if (xDiff > 50) {
                  xTouch = null
                  yTouch = null
                  app.ports.onRightSwipe.send(null)
                } else if (xDiff < -50) {
                  xTouch = null
                  yTouch = null
                  app.ports.onLeftSwipe.send(null)
                }
              }
            }
            document.ontouchcancel = event => {
              xTouch = null
              yTouch = null
            }
            document.ontouchend = event => {
              xTouch = null
              yTouch = null
            }

            // Connect Elm runtime to window JS

            app.ports.error.subscribe(
              msg => console.error(`[ELM] ${msg}`)
            )
            app.ports.requestStoragePersistence.subscribe(
              _ => requestStoragePersistence()
            )

            log(`Starting Elm application.`)
            app.ports.onApplicationStart.send(null)
          })
          .catch(err => fatalError(`no response from navigator.storage.persisted()`))

      })
      .catch(err => fatalError(`service worker not ready: ${err}`))



    // UTILITIES //////////////////////////////////////////////////////////////


    function sendToServiceWorker(title, content) {
      log(`Sending "${title}"...`)
      navigator.serviceWorker.ready
        .then(service => {
          service.active.postMessage({ title: title, content: content })
        })
        .catch(err => error(`Unable to send message "${title}" to service: ${err}`))
    }

    function requestStoragePersistence() {
      navigator.storage.persist().then(granted => {
        if (granted) {
          log("Persistent storage has been granted.")
        } else {
          error('persistent storage has not been granted')
        }
        sendToServiceWorker("persistent storage granted", granted)
        if (navigator.storage.estimate) {
          navigator.storage.estimate().then(info => {
            log(
              `Persistent storage estimation: usage = ${Math.round(info.usage)} bytes, (quota = ${Math.round(info.quota / (1024 * 1024))} Mb).`
            )
          })
        }
      })
    }

    function log(msg) {
      console.log(`[CLIENT] ${msg} `)
    }


    function error(msg) {
      console.error(`[CLIENTJS] ${msg} `)
    }

    function fatalError(msg) {
      document.body.innerHTML =
        `<p>Le navigateur utilisé n'est pas compatible avec cette application:</p><pre>${msg}</pre>`
      throw new Error(msg)
    }


  </script>

</body>

</html>