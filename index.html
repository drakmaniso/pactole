<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Pactole</title>

  <!-- meta http-equiv="Content-Security-Policy" content="style-src 'self'; script-src 'self'; default-src 'self'"-->

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="application-name" content="Pactole">
  <meta name="theme-color" content="#ffffff">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" sizes="512x512" href="images/icon-512x512.png">

  <!--link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;700&display=swap" rel="stylesheet"-->

  <style>
    @font-face {
      font-family: 'Font Awesome 5 Free';
      font-style: normal;
      font-weight: 900;
      font-display: swap;
      src: url("fonts/fa-solid-900.woff2");
    }

    @font-face {
      font-family: 'Andika New Basic';
      font-style: normal;
      font-weight: 400;
      font-display: swap;
      src: url('fonts/andika-new-basic-v15-latin-regular.woff2');
    }

    @font-face {
      font-family: 'Andika New Basic';
      font-style: normal;
      font-weight: 700;
      font-display: swap;
      src: url('fonts/andika-new-basic-v15-latin-700.woff2');
    }

    @font-face {
      font-family: 'System UI';
      font-style: normal;
      font-weight: 400;
      src: local(".SFNS-Regular"), local(".SFNSText-Regular"), local(".HelveticaNeueDeskInterface-Regular"), local(".LucidaGrandeUI"), local("Segoe UI"), local("Ubuntu"), local("Roboto-Regular"), local("DroidSans"), local("Tahoma");
    }

    @font-face {
      font-family: 'System UI';
      font-style: normal;
      font-weight: 500;
      src: local(".SFNS-Medium"), local(".SFNSText-Medium"), local(".HelveticaNeueDeskInterface-MediumP4"), local(".LucidaGrandeUI"), local("Segoe UI Semibold"), local("Ubuntu Medium"), local("Roboto-Medium"), local("DroidSans-Bold"), local("Tahoma Bold");
    }

    @font-face {
      font-family: 'System UI';
      font-style: normal;
      font-weight: 700;
      src: local(".SFNS-Bold"), local(".SFNSText-Bold"), local(".HelveticaNeueDeskInterface-Bold"), local(".LucidaGrandeUI"), local("Segoe UI Bold"), local("Ubuntu Bold"), local("Roboto-Bold"), local("DroidSans-Bold"), local("Tahoma Bold");
    }

    .focus-visible-only:focus-visible {
      border: 4px solid #FFD000;
    }

    .dialog {
      width: 100%;
      max-width: 920px;
      padding: unset;
      border: unset;
      border-radius: 6px;
      box-shadow:
        32px 64px 32px 0px rgba(0, 0, 0, 0.04),
        16px 32px 16px 0px rgba(0, 0, 0, 0.08),
        8px 16px 8px 0px rgba(0, 0, 0, 0.16),
        4px 8px 4px 0px rgba(0, 0, 0, 0.32),
        2px 4px 2px 0px rgba(0, 0, 0, 0.32),
        1px 2px 1px 0px rgba(0, 0, 0, 0.32),
        0px 1px 1px 0px rgba(0, 0, 0, 0.64)
    }

    .dialog::backdrop {
      background: rgba(0, 0, 0, 60%);
    }

    .button-shadow {
      box-shadow:
        32px 64px 32px 0px rgba(0, 0, 0, 0.01),
        16px 32px 16px 0px rgba(0, 0, 0, 0.02),
        8px 16px 8px 0px rgba(0, 0, 0, 0.04),
        4px 8px 4px 0px rgba(0, 0, 0, 0.08),
        2px 4px 2px 0px rgba(0, 0, 0, 0.08),
        1px 2px 1px 0px rgba(0, 0, 0, 0.08),
        0px 1px 1px 0px rgba(0, 0, 0, 0.16)
    }

    .button-shadow:active {
      box-shadow:
        8px 16px 8px 0px rgba(0, 0, 0, 0.01),
        4px 8px 4px 0px rgba(0, 0, 0, 0.02),
        2px 4px 2px 0px rgba(0, 0, 0, 0.04),
        1px 2px 1px 0px rgba(0, 0, 0, 0.08),
        0px 1px 1px 0px rgba(0, 0, 0, 0.16)
    }
  </style>
  <script src="elm.js"></script>
</head>

<body>
  <script>

    // PROGRESSIVE WEB APP ////////////////////////////////////////////////////

    if (!('indexedDB' in window)) {
      fatalError('IndexedDB not supported by browser.')
    }

    if (!('serviceWorker' in navigator)) {
      fatalError('service workers not supported by the navigator.')
    }

    if (!(navigator.storage && navigator.storage.persist)) {
      fatalError('no persistent storage API')
    }


    //TODO: add a settings button to call this?
    let updateService
    onload = () => {
      navigator.serviceWorker
        .register('./service.js')
        .then(registration => {
          updateService = () => registration.update()
          if (registration.installing) {
            log(
              `Service registration: installing (scope: ${registration.scope})`,
            )
          } else if (registration.waiting) {
            log(
              `Service registration: waiting (scope: ${registration.scope})`,
            )
          } else if (registration.active) {
            log(
              `Service registration: active (scope: ${registration.scope})`,
            )
          }
          registration.onupdatefound = () => {
            let w = registration.installing
            log(`Update found: installation in progress...`)
            w.onstatechange = event => {
              if (event.target.state === 'installed') {
                log(`The update has been installed.`)
              }
            }
          }
        })
        .catch(err => error(`Service registration failed: ${err}`))
    }


    var isRefreshing = false
    navigator.serviceWorker.addEventListener("controllerchange", (event) => {
      log("Service worker controller changed.")
      if (isRefreshing) {
        return
      }
      isRefreshing = true
      window.location.reload()
    });


    // ELM STUFF //////////////////////////////////////////////////////////////


    navigator.serviceWorker.ready
      .then(_ => {
        // Check persistent storage status
        navigator.storage.persisted().then(isPersisted => {
          log(`Storage is persisted: ${isPersisted}`)

          const today = new Date()
          const flags = {
            today: {
              year: today.getFullYear(),
              month: today.getMonth(),
              day: today.getDate()
            },
            width: window.innerWidth,
            height: window.innerHeight,
            isStoragePersisted: isPersisted
          }
          const app = Elm.Main.init({ flags: flags })

          navigator.serviceWorker.onmessage = event => {
            log(`Received "${event.data.title}".`)
            app.ports.receive.send([event.data.title, event.data.content])
          }

          app.ports.error.subscribe(
            msg => console.error(`[ELM] ${msg}`)
          )
          app.ports.exportDatabase.subscribe(
            db => exportDatabase(db)
          )
          app.ports.selectImport.subscribe(
            _ => selectImport()
          )
          app.ports.requestStoragePersistence.subscribe(
            _ => requestStoragePersistence()
          )
          app.ports.openDialog.subscribe(
            _ => {
              const dialog = document.getElementById("dialog")
              if (dialog) {
                if (!dialog.open) {
                  dialog.showModal()
                }
              } else {
                error(`unable to open dialog`)
              }
              const focusedField = document.getElementById("dialog-amount")
              if (focusedField) {
                focusedField.focus()
              }
            }
          )
          app.ports.closeDialog.subscribe(
            _ => {
              const dialog = document.getElementById("dialog")
              if (dialog) {
                dialog.close()
              } else {
                error(`unable to close dialog`)
              }
            }
          )
          app.ports.sendToSW.subscribe(function (args) {
            try {
              [title, content] = args
              sendToServiceWorker(title, content)
            }
            catch (err) {
              error(`forwarding service worker message: ${err}`)
            }
          })

          log(`Starting Elm application.`)
          app.ports.receive.send(["start application", null])
        })

      })
      .catch(err => error(`Service worker not ready: ${err}`))



    // UTILITIES //////////////////////////////////////////////////////////////


    function sendToServiceWorker(title, content) {
      log(`Sending "${title}"...`)
      const sw = navigator.serviceWorker.controller
      if (sw) {
        sw.postMessage({ title: title, content: content })
      } else {
        error(`Unable to send message "${title}" to service: the page has no controller`)
        //TODO: what?
      }
    }

    function requestStoragePersistence() {
      navigator.storage.persist().then(granted => {
        if (granted) {
          log("Persistent storage has been granted.")
        } else {
          //TODO: fatalError instead?
          error('persistent storage has not been granted')
        }
        navigator.serviceWorker.ready
          .then(service =>
            sendToServiceWorker("persistent storage granted", granted)
          )
        if (navigator.storage.estimate) {
          navigator.storage.estimate().then(info => {
            log(
              `Persistent storage estimation: usage = ${Math.round(info.usage)} bytes, (quota = ${Math.round(info.quota / (1024 * 1024))} Mb).`
            )
          })
        }
      })
    }

    function exportDatabase(database) {
      let filename = database.filename

      let blob = new Blob([JSON.stringify(database, null, 4)], { type: "text/plain;charset=utf-8" })

      var a = document.createElement("a")
      a.href = window.URL.createObjectURL(blob)
      a.download = `${filename}`
      a.click()
    }

    function selectImport() {
      var input = document.createElement("input")
      input.type = "file"
      input.accept = "application/json,.json"
      input.addEventListener("change", processSelectedImportFile, false)
      input.click()
    }

    function processSelectedImportFile() {
      if (this.files.length != 1) {
        console.error(`[CLIENT] wrong number of selected files: ${this.files.length}`)
        navigator.serviceWorker.ready
          .then(service =>
            sendToServiceWorker("user error", "impossible d'importer plus d'un fichier à la fois")
          )
        return
      }
      const file = this.files[0]
      console.log(`[CLIENT] file selected for import: "${file.name}"`)
      const reader = new FileReader()
      reader.onload = (event) => {
        try {
          const db = JSON.parse(event.target.result)
          sendToServiceWorker("broadcast import database", db)
        }
        catch (err) {
          console.error(`[CLIENT] error in file selected for import: ${err} `)
          navigator.serviceWorker.ready
            .then(service =>
              sendToServiceWorker("user error", "impossible de lire le fichier choisi")
            )
        }
      }
      reader.readAsText(file)
    }

    function log(msg) {
      console.log(`[CLIENT] ${msg} `)
    }


    function error(msg) {
      console.error(`[CLIENTJS] ${msg} `)
    }

    function fatalError(msg) {
      document.body.innerHTML =
        `< div > <h1>Le navigateur utilisé n'est pas compatible avec cette application (raison: "${msg}").</h1>` + document.body.innerHTML
      throw new Error(msg)
    }


  </script>

  <div style="width: 100%; height: 100%;">
    <h1
      style="width: 100%; position: absolute; top: 30%; text-align: center; font-family: 'Work Sans'; font-size: 4em; color: #ddd;">
      Pactole</h1>
  </div>
</body>

</html>